# FSD-0001: Track Inflation on Spend

**BRD:** BRD-0001
**Author:** Claude Code (FSD Agent)
**Date:** 2026-02-20
**Status:** Draft

---

## Design Summary

This specification describes the changes required to make the Monte Carlo simulation inflate all
non-debt spending, tax constants, Social Security payments, payroll deductions, and retirement
savings contributions according to each simulated lifetime's monthly CPI growth rate. A single
`CumulativeCpiMultiplier` value, stored as a renamed/repurposed field on `CurrentPrices`, compounds
each month as `multiplier *= (1 + rates.CpiGrowth)`, and is threaded through every function that
currently uses a fixed base value derived from `PgPerson` or `TaxConstants`. Fun points are
deflated by the same multiplier to preserve the purchasing-power-to-fun-points ratio. Investment
growth already uses `rates.SpGrowth` (the gross S&P500 column from the database), so no change to
asset-price logic is needed for BR-7 (pending DB spot-check confirmation). Debt monthly payments
are already fixed and require no change (BR-4). All adjustments apply monthly with no annual
batching.

---

## BR-7 Verification: S&P Growth Column

**Finding: No code change appears required — pending DB data confirmation.**

`Pricing.cs` line 62 shows the query passed to the VAR fitter selects `x.SpGrowth` (mapped to
DB column `sp_growth` via `[Column("sp_growth")]` at `HistoricalDataPoint.cs:14-15`) and
`x.CpiGrowth` (mapped to `cpi_growth` at `HistoricalDataPoint.cs:17-18`) as separate values. The
VAR generator (`VarLifetimeGenerator.cs:81-82`) emits `SpGrowth` and `CpiGrowth` as two
independent fields on `HypotheticalLifeTimeGrowthRate`.

`Pricing.SetLongTermGrowthRateAndPrices()` at `Pricing.cs:108` applies `rates.SpGrowth` directly
to `CurrentEquityInvestmentPrice`. The column being read is `sp_growth`, not
`inflation_adjusted_growth`.

Dan's Q1 answer states: "I believe SpGrowth is the correct value to use" and identifies two DB
columns — `sp_growth` (gross growth) and `inflation_adjusted_growth` (gross minus CPI). The C#
code already reads `sp_growth`. However, Dan stressed "the technical analysis needs to verify
this." See OPEN DECISION 1 below.

---

## Functional Specifications

| ID      | BRD Trace | Description | Technical Approach |
|---------|-----------|-------------|--------------------|
| FSD-001 | BR-1 | Monthly required spend (non-debt, non-healthcare) inflates each month | `Spend.CalculateMonthlyRequiredSpend()` (`Spend.cs:157`) currently returns fixed `person.RequiredMonthlySpend` (`Spend.cs:161`). Add `decimal cumulativeCpiMultiplier` parameter; return `person.RequiredMonthlySpend * cumulativeCpiMultiplier` for the non-debt portion. |
| FSD-002 | BR-1 | Monthly fun spend inflates each month | `Spend.CalculateMonthlyFunSpend()` (`Spend.cs:59`) returns fixed age-based values. Add `decimal cumulativeCpiMultiplier` parameter; multiply computed base spend by it before returning. |
| FSD-003 | BR-1 | Hardcoded Medicare constants inflate each month | `Spend.CalculateMonthlyHealthSpend()` (`Spend.cs:88`) contains hardcoded `const decimal` values (`partADeductiblePerAdmission=1676m`, `partBPremiumMonthly=370m`, `partBAnnualDeductible=514m`, `partDPremiumMonthly=93m`, `partDAverageMonthlyDrugCost=150m`) at lines 132-138. Add `decimal cumulativeCpiMultiplier` parameter; multiply all hardcoded constants and `person.RequiredMonthlySpendHealthCare` (used at lines 124,127) by it before use. |
| FSD-004 | BR-2 | Cash-need projection function compounds CPI forward | `Spend.CalculateCashNeedForNMonths()` (`Spend.cs:16`) loops forward `nMonths`. Add `decimal cumulativeCpiMultiplier` and `decimal currentCpiGrowthRate` parameters. Each iteration `i` applies `iterationMultiplier = cumulativeCpiMultiplier * (1 + currentCpiGrowthRate)^i` when calling inner spend functions. Debt component (`Spend.cs:163-166`) remains fixed per BR-4. |
| FSD-005 | BR-3 | Fun points earned per dollar decrease with accumulated inflation | `Spend.CalculateFunPointsForSpend()` (`Spend.cs:32`) currently applies only age-based penalty. Add `decimal cumulativeCpiMultiplier` parameter; after computing `funPoints` by existing logic, return `funPoints / cumulativeCpiMultiplier`. Preserves purchasing-power-to-fun-points ratio as specified in BRD Q4. |
| FSD-006 | BR-4 | Debt monthly payments are not inflated — confirmed no-op | `Spend.CalculateMonthlyRequiredSpend()` (`Spend.cs:163-166`) reads fixed `MonthlyPayment` from each open debt position. No change needed. Documents confirmed exclusion. |
| FSD-007 | BR-5 | Federal standard deduction inflates monthly | `Form1040` uses `TaxConstants.FederalStandardDeduction` (`TaxConstants.cs:82`, value `29200.0M`). At the call site, compute `TaxConstants.FederalStandardDeduction * cumulativeCpiMultiplier`. `TaxConstants` fields remain static readonly; only runtime application changes. |
| FSD-008 | BR-5 | NC standard deduction inflates monthly | `FormD400` uses `TaxConstants.NcStandardDeduction` (`TaxConstants.cs:75`, value `25500m`). Replace with `TaxConstants.NcStandardDeduction * cumulativeCpiMultiplier` at point of use. |
| FSD-009 | BR-5 | SS worksheet dollar thresholds inflate monthly | `SocialSecurityBenefitsWorksheet` uses `TaxConstants.SocialSecurityWorksheetCreditLine8` (`32000m`, `TaxConstants.cs:84`) and `TaxConstants.SocialSecurityWorksheetCreditLine10` (`12000m`, `TaxConstants.cs:85`). Both multiplied by `cumulativeCpiMultiplier` at point of use. |
| FSD-010 | BR-5 | ScheduleD capital loss limit inflates monthly | `ScheduleD` uses `TaxConstants.ScheduleDMaximumCapitalLoss` (`-3000m`, `TaxConstants.cs:86`). Multiply by `cumulativeCpiMultiplier` at point of use (makes limit more negative in nominal terms — see OPEN DECISION 4). |
| FSD-011 | BR-5 | OASDI paycheck deduction cap inflates monthly | `Payday.WithholdTaxesFromPaycheck()` (`Payday.cs:220-223`) uses `TaxConstants.OasdiMax` (`11439.0m`, `TaxConstants.cs:96`). Multiply by `cumulativeCpiMultiplier`. Rate `OasdiBasePercent` (`TaxConstants.cs:95`) does not inflate. |
| FSD-012 | BR-5 | Medicare surcharge threshold inflates monthly | `Payday.WithholdTaxesFromPaycheck()` (`Payday.cs:225-228`) uses `TaxConstants.AdditionalMedicareThreshold` (`250000m`, `TaxConstants.cs:99`). Multiply by `cumulativeCpiMultiplier`. Rate `AdditionalMedicareTaxRate` does not inflate. |
| FSD-013 | BR-5 | Federal tax bracket dollar thresholds inflate monthly | `TaxTable` and tax worksheets iterate `TaxConstants.Federal1040TaxTableBrackets` using `bracket.min` and `bracket.max`. `TaxCalculation.CalculateIncomeRoom()` (`TaxCalculation.cs:52`) reads `TaxConstants.Federal1040TaxTableBrackets[1].max` directly. Bracket `min`/`max` dollar amounts scale by `cumulativeCpiMultiplier` at point of use via new helper (see Method Changes). Bracket rates do not change. |
| FSD-014 | BR-5 | FederalWorksheetVsTableThreshold inflates monthly | `TaxConstants.FederalWorksheetVsTableThreshold` (`100000m`, `TaxConstants.cs:87`) is used as a breakpoint in `Form1040`, `QualifiedDividendsAndCapitalGainTaxWorksheet`, and `TaxTable`. Multiply by `cumulativeCpiMultiplier` at each point of use. |
| FSD-015 | BR-6 | Social Security monthly payment inflates with COLA | `Payday.ProcessSocialSecurityCheck()` (`Payday.cs:29`) uses `person.AnnualSocialSecurityWage / 12m` as a fixed value. `AnnualSocialSecurityWage` is set once at simulation start (`LifeSimulator.cs:76-77`, `Person.cs:108`). Add `decimal cumulativeCpiMultiplier` parameter; compute `amount = (person.AnnualSocialSecurityWage / 12m) * cumulativeCpiMultiplier`. `PgPerson` is not mutated. `TaxLedger.SocialSecurityWageMonthly` (set at `LifeSimulator.cs:84`) and its use in `TaxCalculation.CalculateIncomeRoom()` (`TaxCalculation.cs:65,71`) must also receive the inflation-adjusted value. |
| FSD-016 | BR-8 | Pre-tax health deductions on paycheck inflate monthly | `Payday.DeductPreTax()` (`Payday.cs:188`) reads fixed `person.PreTaxHealthDeductions` (`PgPerson.cs:51`). Add `decimal cumulativeCpiMultiplier`; multiply `annualPreTaxHealthDeductions` by it. |
| FSD-017 | BR-8/BR-9 | HSA contributions (employee + employer) inflate monthly | `Payday.AddPaycheckRelatedRetirementSavings()` (`Payday.cs:134`) uses `(person.AnnualHsaContribution + person.AnnualHsaEmployerContribution) / 12m`. Multiply by `cumulativeCpiMultiplier`. Cap at IRS HSA limit × `cumulativeCpiMultiplier` per FSD-019. |
| FSD-018 | BR-8/BR-9 | 401k contributions (pre-tax and post-tax) inflate monthly | `Payday.AddPaycheckRelatedRetirementSavings()` (`Payday.cs:128-131`) uses `person.Annual401KPostTax / 12m` and `person.Annual401KPreTax / 12m`. Multiply by `cumulativeCpiMultiplier`. Cap at IRS elective deferral limit × `cumulativeCpiMultiplier` per FSD-019. `Payday.DeductPreTax()` (`Payday.cs:190`) also uses the pre-tax 401k value; must be consistent. |
| FSD-019 | BR-9 | IRS 401k and HSA contribution limits inflate monthly | Add new constants to `TaxConstants`: `Irs401KElectiveDeferralLimit` ($23,000 base) and `IrsHsaFamilyContributionLimit` ($8,300 base). At runtime, cap adjusted contributions at `irsLimit * cumulativeCpiMultiplier`. Since both contribution and limit scale equally, the effective cap is `Math.Min(baseContribution, irsLimit) * cumulativeCpiMultiplier`. |
| FSD-020 | BR-8 | Post-tax insurance deductions on paycheck inflate monthly | `Payday.DeductPostTax()` (`Payday.cs:170`) reads fixed `person.PostTaxInsuranceDeductions`. Add `decimal cumulativeCpiMultiplier`; multiply `annualInsuranceDeductions` by it. Post-tax 401k at line 169 is coordinated with FSD-018. |
| FSD-021 | BR-1/BR-2 | CumulativeCpiMultiplier computed and stored in CurrentPrices each month | `CurrentPrices.CurrentCpi` (`CurrentPrices.cs:14`, initialized `1.00m`, never updated) is renamed to `CumulativeCpiMultiplier`. Each month, `Pricing.SetLongTermGrowthRateAndPrices()` (`Pricing.cs:102`) adds: `result.CumulativeCpiMultiplier = prices.CumulativeCpiMultiplier * (1m + rates.CpiGrowth)`. `Pricing.CopyPrices()` (`Pricing.cs:125`) must copy the field (currently omitted). |

---

## Data Model Changes

### CurrentPrices (`Lib/DataTypes/MonteCarlo/CurrentPrices.cs`)

**Rename existing field (line 14):**
- From: `public decimal CurrentCpi { get; set; } = 1.00m;`
- To: `public decimal CumulativeCpiMultiplier { get; set; } = 1.0m;`

Initialized to `1.0m` (correct starting value for a multiplicative accumulator). No other structural changes.

**Optional new field (OPEN DECISION 3):**
- `public decimal CurrentCpiGrowthRate { get; set; } = 0m;`

Populated in `Pricing.SetLongTermGrowthRateAndPrices()` to support `CalculateCashNeedForNMonths` projections without further signature proliferation.

**Impact on `CopyPrices`:** `Pricing.CopyPrices()` (`Pricing.cs:125-136`) currently does not copy `CurrentCpi`. After rename, `CumulativeCpiMultiplier = originalPrices.CumulativeCpiMultiplier` must be added. Omitting this would reset the multiplier to `1.0m` every month — a simulation-breaking bug.

### TaxConstants (`Lib/StaticConfig/TaxConstants.cs`)

New constants (base-year values, inflated at runtime):
- `public const decimal Irs401KElectiveDeferralLimit = 23000m;` — combined pre+post-tax 401k annual elective deferral cap
- `public const decimal IrsHsaFamilyContributionLimit = 8300m;` — annual HSA family contribution cap

No existing constants are changed. All existing constants remain compile-time base values.

### PgPerson — No Changes

`PgPerson` is immutable within a simulation run. All inflation adjustments are computed on-the-fly
by multiplying base values from `PgPerson` by `cumulativeCpiMultiplier`. `Person.CopyPerson()`
does not require changes; `AnnualSocialSecurityWage` stored there remains the base-year value.

---

## Method / API Changes

All new `cumulativeCpiMultiplier` parameters are appended at the end of each existing signature
to minimize call-site disruption. Callers in `LifeSimulator` and `Simulation` extract the value
from `_simData.CurrentPrices.CumulativeCpiMultiplier`.

### Spend.cs changes

| Method | Change |
|--------|--------|
| `CalculateMonthlyFunSpend` | Add `decimal cumulativeCpiMultiplier`; multiply base spend before return |
| `CalculateMonthlyHealthSpend` | Add `decimal cumulativeCpiMultiplier`; multiply all hardcoded Medicare constants and `person.RequiredMonthlySpendHealthCare` |
| `CalculateMonthlyRequiredSpend` | Add `decimal cumulativeCpiMultiplier`; multiply standard spend; pass through to `CalculateMonthlyHealthSpend`; debt portion unchanged |
| `CalculateMonthlyRequiredSpendWithoutDebt` | Add `decimal cumulativeCpiMultiplier`; thread through |
| `CalculateFunPointsForSpend` | Add `decimal cumulativeCpiMultiplier`; divide final `funPoints` by it |
| `CalculateCashNeedForNMonths` | Add `decimal cumulativeCpiMultiplier, decimal currentCpiGrowthRate`; apply compounding forward multiplier per iteration |

### Payday.cs changes

| Method | Change |
|--------|--------|
| `DeductPreTax` | Add `decimal cumulativeCpiMultiplier`; multiply `annualPreTaxHealthDeductions` |
| `DeductPostTax` | Add `decimal cumulativeCpiMultiplier`; multiply `annualInsuranceDeductions` |
| `AddPaycheckRelatedRetirementSavings` | Add `decimal cumulativeCpiMultiplier`; multiply 401k and HSA amounts; apply inflation-adjusted IRS caps |
| `WithholdTaxesFromPaycheck` | Add `decimal cumulativeCpiMultiplier`; multiply `OasdiMax` and `AdditionalMedicareThreshold` |
| `ProcessSocialSecurityCheck` | Add `decimal cumulativeCpiMultiplier`; multiply SS monthly amount |
| `ProcessPreRetirementPaycheck` | Add `decimal cumulativeCpiMultiplier`; thread to all sub-calls |

### Pricing.cs changes

| Method | Change |
|--------|--------|
| `SetLongTermGrowthRateAndPrices` | Add `result.CumulativeCpiMultiplier = prices.CumulativeCpiMultiplier * (1m + rates.CpiGrowth)` and optionally `result.CurrentCpiGrowthRate = (decimal)rates.CpiGrowth` |
| `CopyPrices` | Add `CumulativeCpiMultiplier = originalPrices.CumulativeCpiMultiplier` to returned initializer |

### TaxCalculation.cs changes

| Method | Change |
|--------|--------|
| `CalculateTaxLiabilityForYear` | Add `decimal cumulativeCpiMultiplier`; thread to `Form1040` and `FormD400` constructors |
| `CalculateIncomeRoom` | Add `decimal cumulativeCpiMultiplier`; multiply bracket threshold and standard deduction at lines 52,55; apply multiplied SS wage at lines 65,71 |

**New helper: `TaxCalculation.ScaleBracketThresholds`**
- Signature: `public static (decimal rate, decimal min, decimal max)[] ScaleBracketThresholds((decimal rate, decimal min, decimal max)[] brackets, decimal cumulativeCpiMultiplier)`
- Returns new array with `(rate, min * multiplier, max * multiplier)` per bracket; `decimal.MaxValue` sentinels remain unchanged.
- Used by `TaxTable`, `TaxComputationWorksheet`, `QualifiedDividendsAndCapitalGainTaxWorksheet`, and `CalculateIncomeRoom`.

### Tax form changes (`Form1040`, `FormD400`, worksheets, `ScheduleD`)

Each form or its calculation method gains `decimal cumulativeCpiMultiplier`. Thread from
`TaxCalculation.CalculateTaxLiabilityForYear` (entry point). Inside each form:
- Multiply flat-dollar constants by `cumulativeCpiMultiplier` at point of use
- Pass to `ScaleBracketThresholds` before bracket iteration

### Withdrawal strategy call-site changes

`CalculateCashNeedForNMonths` call sites in:
- `SixtyForty.cs:131`
- `SharedWithdrawalFunctions.cs:56, 110, 376`
- `NoMidIncomeThreshold.cs:65`

All already receive `CurrentPrices` in scope. Each call site adds:
- `currentPrices.CumulativeCpiMultiplier`
- `currentPrices.CurrentCpiGrowthRate` (if OPEN DECISION 3 is approved)
  or a separately passed `decimal currentCpiGrowthRate`

### Simulation.cs call-site changes

| Method | Change |
|--------|--------|
| `PayForStuff` | Add `decimal cumulativeCpiMultiplier`; pass to `CalculateMonthlyFunSpend`, `CalculateMonthlyRequiredSpendWithoutDebt`, `CalculateFunPointsForSpend` |
| `RecordFunAndAnxiety` | Add `decimal cumulativeCpiMultiplier`; pass to `CalculateMonthlyRequiredSpend` |
| `ProcessPayday` | Add `decimal cumulativeCpiMultiplier`; thread to paycheck and SS functions |
| `PayTaxForYear` | Add `decimal cumulativeCpiMultiplier`; pass to `CalculateTaxLiabilityForYear` |

---

## Cumulative CPI Multiplier — Design Decision

**Chosen home: `CurrentPrices.CumulativeCpiMultiplier` (repurposed from `CurrentPrices.CurrentCpi`)**

**Justification:**

1. `CurrentPrices` already flows through every part of the simulation that needs the multiplier —
   it is a member of `SimData` (`SimData.cs:37`), updated by `Simulation.SetNewPrices()` at the
   top of every monthly loop iteration (`LifeSimulator.cs:140`), and passed to withdrawal
   strategies, payday functions, and rebalancing logic.

2. `CurrentPrices` already has `CurrentCpi { get; set; } = 1.00m` (`CurrentPrices.cs:14`) —
   initialized to `1.00m`, never updated, and commented "set it to $1 to start." This is exactly
   the right starting value for a multiplicative accumulator. Repurposing it avoids adding a new
   field to a struct that is already copied and passed everywhere.

3. `Pricing.SetLongTermGrowthRateAndPrices()` (`Pricing.cs:102`) is the single function that
   reads `HypotheticalLifeTimeGrowthRate` each month and updates all price fields on
   `CurrentPrices`. Adding the CPI compound here keeps all per-month price state mutations in one
   place — consistent with how `CurrentEquityGrowthRate` (`Pricing.cs:107`) and
   `CurrentTreasuryCoupon` (`Pricing.cs:113`) are managed.

4. `CopyPrices` already copies every other field; the multiplier field fits naturally there.

**Monthly update formula** (matching BRD Q2 compounding answer):
```
result.CumulativeCpiMultiplier = prices.CumulativeCpiMultiplier * (1m + rates.CpiGrowth);
```

Month 0: multiplier = 1.0 (base year)
Month 1 (CPI = 0.01): multiplier = 1.01
Month 2 (CPI = 0.005): multiplier = 1.01 × 1.005 = 1.01505
All spend at month 2 = baseSpend × 1.01505

---

## Out of Scope

Matching BRD Out of Scope section:

1. Database table updates to initial spend values (`PgPerson`, `Model` fields)
2. Code constants that initialize values pre-simulation start (TaxConstants values themselves unchanged)
3. Historical DB data changes for BR-7 (if `sp_growth` is confirmed gross, no change; if correction needed, separate work item)
4. VAR model refitting (separate work item if DB data correction required)
5. Bond asset class / treasury coupon downstream wiring (`CurrentTreasuryCoupon` is dead code per AgentContext.txt:160)
6. Dividend yield recalibration (`MidTermGrowthRateModifier` adjustment is a separate current focus item)

---

## Unresolved Design Decisions

**OPEN DECISION 1 — BR-7 DB Column Identity:**
`Pricing.cs:62` reads the column `sp_growth` via `HistoricalDataPoint.SpGrowth`. Dan believes
this is gross S&P growth. A spot-check SQL query must compare a known month's `sp_growth` value
against published S&P500 monthly returns to confirm. If gross: no further action for BR-7. If
net-of-CPI: DB data correction and VAR refit required as a separate work item.

*Dan's decision:* ___

I have profiled the data and can confirm that sp_growth is gross growth. It is derived as:
>(sp_current_value - sp_prior_value) / sp_prior_value 
---

**OPEN DECISION 2 — Employer 401k Match Inflation:**
`Payday.AddPaycheckRelatedRetirementSavings()` (`Payday.cs:132`) computes employer 401k match as
`(person.AnnualSalary * person.Annual401KMatchPercent) / 12m`. This is percentage-based, not a
flat fee, and is not explicitly covered by BR-8 or BR-9. This FSD does not inflate it.
Should the employer match also inflate with CPI?

*Dan's decision:* ___
No. The employer match % should remain flat throughout the simulation.
---

**OPEN DECISION 3 — CurrentCpiGrowthRate field on CurrentPrices:**
`CalculateCashNeedForNMonths` (FSD-004) needs the current month's CPI growth rate to project
future months. This FSD recommends adding `CurrentCpiGrowthRate { get; set; } = 0m` to
`CurrentPrices` and populating it in `Pricing.SetLongTermGrowthRateAndPrices()`. The alternative
is passing it as a separate parameter to `CalculateCashNeedForNMonths` and its four call sites.
Which approach is preferred?

*Dan's decision:* ___
The FSD recommendation is correct. It should be added to the CurrentPrices class
---

**OPEN DECISION 4 — ScheduleD capital loss limit inflation direction:**
`TaxConstants.ScheduleDMaximumCapitalLoss = -3000m` is negative. Multiplying by
`cumulativeCpiMultiplier > 1` makes it more negative (e.g., `-3090m` at 3% inflation), meaning
a larger nominal deductible loss. This is consistent with how all other dollar thresholds inflate
(more generous in nominal terms). Please confirm this is the intended behavior.

*Dan's decision:* ___
I believe that the negative expansion is correct. As money becomes less valuable, what the IRS considers to be a 
"meaningful" loss should also increase. In other words, when \$3000 has half of its spending power, then the new 
"meaningful" loss should then be $6000.